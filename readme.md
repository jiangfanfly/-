# 无人驾驶 学习 入门（参考appllo入门与进阶课程）

虽然我的方向是slam，只是无人驾驶中高精度地图和定位中的一小部分，但是一直关注着无人驾驶，感觉还是有必要了解一小无人驾驶的整体全貌，开始学习无人驾驶的相关知识，在此记录一下。


-----
## 概述
无人驾驶的优点
1.安全
2.学习能力，经验丰富
3.停车难问题

分级0-5级
level0 只有人
level1 部分自动巡航，转向加速辅助
level2 部分自动化，巡航，车道保持
level3 有条件的无人驾驶，必要时需要人的接管
level4 无人，地理围栏内车辆自动行驶 
level5 完全无人自动化

历史
1986 CMU 第一次
1998 Mercedes 最新技术 许多大学公司参加
2005 Sebastian Thrun 斯坦福DAPRA比赛  后加入谷歌
2017 apollo

how a self-drving car works
计算机视觉  
            定位 路径规划 控制
传感器融合

线控驾驶车辆
CAN 控制区域网络 加速制动转向
GPS
IMU  定位
LADAR
CAMERA 感知
Radar 分辨率低  便宜 测量速度 对天气适应性强

开源软件框架
RTOS
ROS -> nodes master to domain 避免master坏所有节点坏
    protobuf消息代替ros 原生消息

云服务
data 应用程序 
高精度地图 HD map
仿真 simulation * 记录/虚拟场景
Data platform
security
OTA 空中软件
DuerOS

----------------------------------- 

## 高精度地图 HD maps
定位 预先规划
语义 几何 精度厘米级

匹配 定位
感知 ROI 提高精度加快速度节约资源
规划 车道中心线 预先减速 变道

道路定义 路口 交通信号灯 格式 OpenDRIVE（section reference line） NDS

构建：
数据采集  
数据处理 整理分类清洗
对象检测
人工/手动验证
地图发布 

众包

厂商
here 
MobileEye 偏视觉
谷歌 waymo 激光+视觉 
TomTom


apollo 激光+视觉
采集-
点云拼接（slam位姿优化）+点云投影到图像 进行标注
图像  深度学习
人工验证

成功：
定位地图 高精地图 路径规划地图、仿真地图

挑战：
测绘政策

----------------------------------- 

## 定位 localization
GPS 一般1-3m 高楼 10-50m
传感器

GNSS RTK , IMU, LIDAR ,视觉

GNSS RTK
三角测量 地球表面三角测量
卫星 控制站 接收机
接收至少4颗卫星  接收时间算距离 原子钟
rtk 基站 10cm以内 高楼内精度差 频率低 10hz

IMU 加速度计 角速度计/陀螺仪 频率高 误差累计严重 

Lidar ICP 滤波  SSD  直方图滤波 KALMAN滤波
稳健性

视觉 粒子滤波 

apollo IMU预测 Lidar，gnss更新


需求 精度 10cm 鲁棒性 30cm 场景 气候，天气

基于电子信号定位GNSS rtk  伪距差分 载波相位差分 整周数，整周模糊度
航迹推算IMU  
环境特征匹配lidar，camera

地心惯性坐标系ECI  I系
地心地固坐标系ECEF E系
当地水平坐标系 ENU东北天 N系
车体坐标系 车轴后面中间 imu安装此位置 x右 y-前 z上 UTM投影
IMU 车体坐标系基本相同有误差
相机坐标系
激光坐标系 前x y左 上z

阿波罗
gnss ppp rtk
授时 HDmap 在线定位

激光点云 输入pose初值，点云 输出xyz yaw（基于lk光流） 
SSD

视觉定位

捷联惯导 组合导航

----------------------------------- 

## 感知 perception
计算机视觉
核心任务   检测 分类 跟踪 语义

输入， 预处理resize 旋转 颜色转换 ，特征 形状 ，分类模型

图像二维矩阵 颜色 三维 

lidar  点云 检测分类

机器学习 模型 20.60 监督学习 非监督学习 半监督学习 强化学习

神经网络 反向传播算法 前馈 误差测定输出与真值 反馈微调
CNN 二维输入

检测分类 CNN 对象位姿 CNN 分类  输出多个 rcnn faster-rcnn yolo
跟踪 boardingbox跟踪  确认身份  估计下一时刻位置速度
语义分割 每个像素 cnn fcn 编码 解码 unet

apollo roi  点云 深度学习
    yolo 道路 行人 车辆 

传感器优缺点 感知融合
卡尔曼滤波 预测更新

感知

概论
sensor 
地图
输出
  道路信息 障碍物信息 传感器融合 信号灯信息

传感器和标定
    lidar 识别稀疏  功率限制，感知距离 
    camera 光照 稠密
    radar 测距测速准 噪声大 对非金属识别效果差 稀疏
    超声波 近距离
    高精地图
安装 
标定 
内参 
外参 
标定间
camera-camera pnp 
lidar-camera pnp icp
lidar-lidar pnp icp
lidar-gps  绕8字

自然场景
找边缘

感知算法
点云 
启发式方法 Ncut 图割  基于graph 的cluster 缺乏语义
机器学习 CNNseg frontview birdview

检测 分割 
场景分割
可行驶区域
车道线
后处理计算 2D - 3D 时序信息计算跟踪 多相机环视计算融合

红绿灯

感知流程 sensor选型 双camera 长短焦   高精度地图交互 3d坐标 roi区域 深度学习 检测 分类

radar 
Uultrasonic 超声波
机器学习
漏检误检

未来
sensor迭代
深度学习 仿真 芯片
V2X

----------------------------------- 

## 预测 prediction
！！需要实时性 
1. 基于模型的  直观
2. 基于数据驱动的 机器学习训练

车道序列

障碍物 车道边界横向纵向情况
预测目标车道 模型 预测问题 -》选择问题 概率

递归神经网络 rnn  每层输入 输入下一层预测
    车道序列 障碍 输入两个rnn

轨迹生成 初始 终点   数学拟合 多项式

----------------------------------- 


## 规划 planning 决策
目标：生成舒适避免碰撞的轨迹
点构成  时间戳 速度 
路线导航  决策

1.高等级规划 
选择出发地到目的地的路线
路由 输入 map 当前位置 目的地
搜索 地图转换为图 路径 节点-路段 边-连接
A* 网格世界 每个节点下一步有8个选择 考虑成 开始到候选本 候选到目的地成本 ghf value
Dijkstra
2.低等级规划 
更高精度 与附近车互动
点构成  时间戳 速度   3d轨迹 2d坐标加时间

评估轨迹 合法 可能 成本函数 每个轨迹都有  超出中心线等等
不同场景成本函数不同，评估不同

frenet坐标 汽车相对于道路坐标   纵坐标 沿中心线走的路程 横坐标 离中心线距离

两种：路径-速度解耦 规划Lattice规划

路径-速度解耦 规划
路径规划 生成候选轨迹 成本函数评估  考虑“ 离中心线距离 离障碍物距离 速度，曲率变换 车辆压力  ST图 y位置-x时间 斜率是速度
速度规划 速度曲线 st图设置障碍在某一时间段某一位置段
二次规划  将网格图线折线 拟合 曲线化
流程：  生成路径 成本函数选择  ST图 选择速度 设置障碍物 得到最后轨迹

Lattice规划
三维轨迹分解为两个二维问题  分别成本函数估计  
1. ST 沿中心线位置-时间图   分为巡航 跟随 停止 t-v时间速度曲线   
2. SL 沿中心线位置-离中心线距离  车辆朝向 位置 一阶导数二阶导数 均为0
最后合并两个结果 转换为笛卡尔坐标系 得到三维坐标 ST-SL均有S 沿中心线位置匹配生成


决策规划：
规划的本质 是搜索 最优解

argmin
search BFS DFS no-informatics
A*  要求全局信息了解
partial obseved 贪心 D*  incremental search
fully obseved A*
安全平稳

求解 离散化
configuration space
lattice sampling 
    在sl坐标系下撒点 动态规划
    横向纵向
RRT 离散点找最近最优

----------------------------------- 

## 控制 control

控制器有两种输入
目标轨迹 来自规划模块 指定一个位置和一个速度
车辆状态 位置本地化模块 速度,转向,加速度来自传感器模块
控制器输出是
控制输入（转向，加速，制动）的值


PID 比例积分微分控制 线性
比例（proportional）、积分（integral）、微分（derivative）
P 按比例去调整 离得越远调节越大  KP越大，调节作用越激进
D 微分 稳定作用 控制被控制物理量的变化速度趋于0
I 积分 设置一个积分量。只要偏差存在，就不断地对偏差进行积分（累加），并反应在调节力度上。
    I的作用就是，减小静态情况下的误差，让受控物理量尽可能接近目标值。

问题：线性系统，不足以应付复杂系统，无人驾驶转向加速  
        依赖于实时误差测量，所以可能受到测量延时的影响

LQR 线性二次调节器 

Apollo 使用 LQR 进行横向控制。
横向控制包含四个组件：横向误差、横向误差的变化率、朝向误差、朝向的变化率。称这四个组件的集合为 x，这个集合 x 捕获车辆的状态。该车有三个控制输入：转向、加速、制动，将这个控制输入集合称为 u。
x' = Ax + Bu 
x的变化受当前x状态和控制输入u的影响

Q 误差最小化
cost = f积分 xtQx + utRu dt

MPC 模型预测控制
依赖于数学优化
1. 建立车辆模型，该模型近似于汽车的物理特性，特别估计了假如将一组控制输入应用于车辆时会发生什么。
2. 使用优化引擎计算有限时间范围内的控制输入
型发送到搜索最佳控制输入的优化引擎，该优化引擎的工作原理是通过搜索密集数学空间来寻求最佳解决方案，为缩小搜索范围优化引擎依赖于车辆模型的约束条件
3. 执行第一组控制输入
是一个重复过程

模型预测控制考虑了车辆模型，因此比PID控制更精确，也适用于不同的成本函数。另一方面与PID控制相比，模型预测控制相对更复杂、更缓慢、更难以实现。

-------
## ROS
概述
跨语言 分布式

节点管理器master roscore 默认启动rosout隐藏节点，用于记录日志
启动节点 

roslaunch shell 脚本文件   启动多个节点（先检测roscore）

ros spin() 使用回调函数处理

topic  基于TCP 加左斜杠 / 表示全局  不加的话 会有publisher的作用域namespace
msg

service servicename 
src

action 提供取消功能 act
Paramter 

rosbag 回放数据

Rviz可视化工具 可视化node拓扑结构

无人驾驶用的比较多的
TF坐标转换 rosrun monitor
RQT ros qt 图形化展示 rqt graph
URDF robot model
SDF 仿真

编译 基于cmake catkin

ROS Packages
Package.xml 
CMakeLists.txt 


### apollo ROS

问题：
数据传输 大数据 瓶颈
单中心化节点
分布式
msg 数据兼容 数据格式缺乏后向兼容

apollo改进
比如camera 会被多个模块节点订阅，会被复制多次

基于共享内存减少copy次数
去中心化网络拓扑 建立节点与节点之间的复杂拓扑
数据兼容性扩展 protobuf 




-------
## 系统构成
1. 用户端系统
a. 必须确保大量的传感器数据可以及时快速得到处理
b. 某一部分失效时，系统要足够稳定不受影响 并从错误中恢复
c. 必须在设置的资源设定下完成计算操作

机器人操作系统 ROS
用于无人驾驶有如下问题
a. 可靠性 ROS使用主单节点结构
b. 性能 节点之间使用广播通信。产生多次信息复制
c. 安全 没有加密机制
2. 硬件平台

3. 云平台
仿真
高精度地图
深度学习模型训练

## Lidar
1. 激光反射器 波长600~10000nm
2. 扫描与光学部件 用于手机反射点距离该店发生的时间和水平角度
3. 感光部件 检测返回光的强度
可以得到(x,y,z)坐标和光强度信息

应用：
1. 高精度地图的绘制
2. 基于点云的定位
3. 障碍物检测
面临挑战：
1. 空气中的悬浮物
2. 计算量大
3. 成本高

## GPS、IMU
GPS城市峡谷多路径效应，更新频率低10hz
IMU更新频率高，误差累计严重

GPS 
至少4颗卫星才可以定位，未知的有接收机坐标x y z 和接收机钟差 4个未知数。
卫星带原子钟，接收机不带。因此需要多一颗卫星修正时间。

IMU
分低精度几美元，中等精度，常用于汽车导航，几百上千美元，高精度惯导，军用宇航，几十万美元。

## 摄像头
物体识别跟踪 定位
需要达到60fps 留给每帧处理的时间只有16ms

## CNN

## 增强学习
目的 通过和环境交互学习到如何在相应的观测中采取最优行为。

## ROS
1. 节点node 功能独立
2. 节点管理器master 用来管理节点
3. 参数服务器Parameter Server 节点运行时用来存取参数，主要存放运行所需配置参数
4. 消息 Message 节点之间通信内容为消息 类型域构成的数据结构
5. 主题 topic 消息传输围绕一个特定主题，主题名称为传输消息的主要内容

服务 Service
任务 Action

需要进行的改进以提升无人驾驶可靠性：
1.去中心化  备份主节点 或者不保留主节点
2.实时监控报警 监控运行数据
3.节点宕机状态恢复

------------------
## 硬件平台
传感器平台 计算平台 控制平台

### 传感器平台
包括超声波雷达、激光雷达、毫米波雷达、车载摄像头、红外探头（夜视）、gps/imu

激光雷达 可见和近红外波段多为950nm附近 3d建模环境感知 slam定位

毫米波雷达 无线电毫米波波段1-10mm  工作频段30GHZ-300GHZ 可以检测30-100m远，不受天气状况限制
            精度低 可视范围角度偏小
频段 24,60，77,79GHZ 主流为24GHZ，77GHZ，分别用于中短距，中长距测量。
ADAS 配置 1长+4中短

相机
单目 后视 双目立体 环视
高动态 明暗差役大时仍可识别 中低像素 降低计算负担 角度要求：环视后视 广角镜头135以上 前置 55度

GPS/IMU

V2X 是 V2V（车车通信）、V2I（车路通信）、V2P（车人通信）
### 计算平台
GPU DSP(Digitial Singnal Processor) FPGA ASIC
TPU张量处理单元 Tensor 概率芯片

### 控制平台
电子控制单元（ECU） 通信总线 电子控制单元（ECU）实现控制算法 通信总线实现ECU及机械部件间的通信功能
电子控制单元（ECU） CAN控制器区域网（controller Aera Network）协议
通信总线  ABCD四类  
LIN CAN FlexRay

## 无人驾驶安全

## 仿真模拟平台
基于Spark ROS的分布式平台


## 高精度地图
定位 
导航控制

## 无人驾驶的未来
商业前景
公共交通 快递工业应用 老年人残疾人
面临障碍
恶劣天气 行车安全 隐私保护 基础设施不足 频谱不足 事故追责 行车立法

